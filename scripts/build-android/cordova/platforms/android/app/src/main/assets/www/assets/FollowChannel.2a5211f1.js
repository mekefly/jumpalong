var f=Object.defineProperty;var y=(r,n,e)=>n in r?f(r,n,{enumerable:!0,configurable:!0,writable:!0,value:e}):r[n]=e;var u=(r,n,e)=>(y(r,typeof n!="symbol"?n+"":n,e),e);import{g as C}from"./channel.8f39afd5.js";import{g as M}from"./event.e2dea496.js";import{a as U}from"./user.a4fb9555.js";import{T as k,a1 as m,S as b,U as p,W as w,$ as v,a0 as E,a4 as d,a5 as A}from"./index.de60ca02.js";class R extends k{constructor(n,e){super(n,e)}getFilters(){return this.getAddressPointers().map(n=>({kinds:[n.kind],authors:[n.pubkey],["#d"]:[n.identifier]}))}}function L(){return m("getFollowChannelConfiguration",()=>{const r=b(new S);return setTimeout(()=>{r.sync()}),r},{useLocalStorage:!1})}class S extends R{constructor(){super("follower-channel",new Map);u(this,"identifier","follower-channel");u(this,"kind",30001)}getAddressPointers(){return[{identifier:this.identifier,kind:this.kind,pubkey:p.value.publicKey}]}serializeToData(e){const t=new Map,a=w(e.tags);for(const l of a){const{eventId:i,relay:o,marker:s}=l;this.getData();const c={channelMeta:{relayUrls:[o]},channelId:i,relayUrls:new Set};t.get(i)||this.reqMetadata(i,c),t.set(i,c)}return t}deserializeToEvent(e,t){const a=[];a.push(["d",this.identifier]);for(const[l,i]of e.entries()){const o=i.channelMeta.relayUrls;if(o){const s=o[0];if(s){a.push(["e",l,s]);continue}}a.push(["e",l])}return v({kind:this.kind,tags:a})}hasJoin(e){return this.getData().has(e)}setChannelmetadata(e,t){const a=this.getData().get(e);a&&(a.channelMeta=t)}joinChannel(e,t){var s;if(!e)return;const a=this.getData();if(a.get(e))return;const i=this.toChanged(),o={channelId:e,channelMeta:(s=t==null?void 0:t.channelMetadata)!=null?s:{},relayUrls:new Set};t!=null&&t.channelMetadata||this.reqMetadata(e,o,i),a.set(e,o),this.save()}reqMetadata(e,t,a){const l=C(e),i=E((s,c)=>{var h;if(a&&this.isReChange(a)){l.closeReq();return}Object.assign(t.channelMeta,s),d(t.relayUrls,(h=t.channelMeta.relayUrls)!=null?h:[])},3e3);l.feat.onHasMetadata(i),M(e).feat.onHasEventOnce(s=>{const c=s.pubkey;t.creator=c,t.event=s;const h=A(s.tags);d(t.relayUrls,h),U(c).feat.onHasReadWriteList(g=>{d(t.relayUrls,g.writeUrl),d(t.relayUrls,g.readUrl)})})}leaveChannel(e){if(!e)return;const t=this.getData();!t.has(e)||(this.toChanged(),t.delete(e),this.save())}}export{L as g};
