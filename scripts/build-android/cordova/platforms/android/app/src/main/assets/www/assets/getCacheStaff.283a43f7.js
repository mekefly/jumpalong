var b=Object.defineProperty;var A=(a,t,e)=>t in a?b(a,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):a[t]=e;var r=(a,t,e)=>(A(a,typeof t!="symbol"?t+"":t,e),e);import{a6 as h,a7 as M,a8 as l,X as m,a9 as B,a3 as v,aa as w,ab as C,ac as S,ad as R,ae as L,af as g,a1 as U,Y as T,ag as W,ah as E,S as F}from"./index.de60ca02.js";function q(){const a=new Set;return h({push(t){const e=t.id;if(a.has(e))return M.BREAK;a.add(e)}})}class O{constructor(){r(this,"interval",3e3);r(this,"maximumTimes",30);r(this,"setToBeAdded",new Set);r(this,"added",new Set);r(this,"count",0);r(this,"timer");r(this,"eventBeltline");r(this,"filterMap",new Map)}stop(){clearInterval(this.timer),this.timer=void 0}getIndex(){return Math.floor(Math.random()*this.setToBeAdded.size)}init(){}getEventBeltline(){var t;return(t=this.eventBeltline)!=null?t:this.eventBeltline=m.createChild()}startProcessing(){this.count=0,this.init(),!this.timer&&(this.timer=setInterval(()=>{this.count++;let t=this.setToBeAdded.size;if(t<=0&&(this.setToBeAdded=new Set(B.getOtherList()),t=this.setToBeAdded.size),t<=0||this.filterMap.size<=0||this.count>this.maximumTimes){this.stop();return}const e=this.getIndex(),i=Array.from(this.setToBeAdded)[e];this.added.add(i),this.setToBeAdded.delete(i);const s=Array.from(this.filterMap,([o,u])=>u),n=this.eventBeltline.createChild().addFilters(s).addStaff(v()).addRelayUrls(new Set().add(i));setTimeout(()=>{n.closeReq()},2e4),this.getEventBeltline().addExtends(n)},this.interval))}addFilter(t){for(const e of t)c.filterMap.set(JSON.stringify(e),e);c.startProcessing()}removeFilters(t){if(!!t)for(const e of t)c.filterMap.delete(JSON.stringify(e))}}const c=new O;function z(){let a=null,t=!1;function e(){t=!0,a&&c.removeFilters(a)}function i(){t=!1,a=this.beltline.getFilters();const s=this.beltline.createChild().addFilters(a).addExtends(c.getEventBeltline());this.beltline.addExtends(s),!t&&c.addFilter(a)}return h({initialization(){i.apply(this)},feat:{startAutomaticRandomRequestStaff:i,stopAutomaticRandomRequestStaff:e},onClose(){e()}})}const x=l()(()=>({initialization(){this.beltline.feat.onHasLatestEventOnce(()=>{this.beltline.feat.stopAutomaticRandomRequestStaff()})}})),k=l()(()=>({feat:{onHasReadWriteList(a){this.beltline.feat.onHasLatestEvent((t,e)=>{const i=w(t.tags);a(i,e)})}}})),K=l()(()=>({feat:{getReadWriteList(){return this.beltline.feat.onHasReadWriteList(a=>{this.readWriteList=a}),this.readWriteList}}})),I=l()((a=30*1e3)=>({initialization(){this.beltline.onAfterReq(({subId:t})=>{setTimeout(()=>{this.beltline.closeReqBySubid(t)},a)})}})),P=l()(()=>({feat:{withEvent(){return this.beltline.getList().length>0},async timeoutWithEvent(a=2e3){return await C(2e3),this.beltline.feat.withEvent()}}}));class y{constructor(t){r(this,"map",{});r(this,"KEY");r(this,"cacheOption",{duration:1e3*60*60*24*3,...S});this.KEY=t;const e=localStorage.getItem(t);if(!e)return;const i=JSON.parse(e);typeof i=="object"&&(this.map=i)}allMap(){const t={},e=this.map;for(const i in e){const s=this.get(i);!s||(t[i]=s)}return t}set(t,e){const i=e.id;this.map[t]=i,R(i,e,this.cacheOption),this.updateMap()}delete(t){delete this.map[t],L(t),this.updateMap()}get(t){return this._getEvent(t)}_getEvent(t){const e=this.map[t];if(!!e)try{return g(e,this.cacheOption)}catch{this.delete(t);return}}updateMap(){localStorage.setItem(this.KEY,JSON.stringify(this.map))}}class p extends y{constructor(t){super(t)}add(t){this.set(t.pubkey,t)}deleteEventByPubkey(t){this.delete(t)}getByPubkey(t){return this.get(t)}}const H={kind10002:new p("ReplaceableEventMap:kind10002"),kind0:new p("ReplaceableEventMap:kind0"),channelMetadataEventMap:new y("channelMetadataEventMap")},N=l()((a,t)=>({initialization(){const e=H[`kind${a}`],i=e.getByPubkey(t);i&&this.beltline.pushEvent(i),this.beltline.feat.onHasLatestEvent(s=>{e.add(s)})}}));function Y(a,t){return h({initialization(){const e=this.beltline;U(`autoAddRelayurlByPubkey:${a}`,()=>{const s=e.createChild(),n=s.createChild().addStaff(I()).addStaff(v()).addStaff(q()),o=n.createChild().addFilter({kinds:[10002],authors:[a]}).addStaff(T()).addStaff(N(10002,a)).addStaff(k()).addStaff(P()).onAddFilters(d=>{n.addFilters(d)});return o.feat.onHasReadWriteList(d=>{s.addRelayUrls(d.writeUrl)}),W(`createAddRelayUrlGraspClues:${a}`,()=>{n.addRelayUrls(s.getRelayUrls()),s.onAddRelayUrlsAfter(d=>{n.addRelayUrls(d)})},E.syncInterval6),n.createChild().addFilter({kinds:[2],authors:[a]}).onAddFilters(d=>{n.addFilters(d)}).addStaff({push(d){s.addRelayUrl(d.content)}}),(async()=>{o.feat.withEvent()||(n.addExtends(m),!o.feat.withEvent()&&(t!=null&&t.urls&&(n.addRelayUrls(t.urls),await o.feat.timeoutWithEvent())||(n.addReadUrl(),!await o.feat.timeoutWithEvent()&&o.addStaff(z()).addStaff(x()))))})(),s},{useLocalStorage:!1}).onAddRelayUrlsAfter(s=>{e.addRelayUrls(s)})}})}const f=F(new Map),D=l()(()=>({push(a,t,{url:e}){if(e){const i=f.get(a.id);i?i.add(e):f.set(a.id,new Set().add(e))}},feat:{getSourceUrls:J}}));function J(a){return f.get(a)}const _={duration:E.eventCacheDuration,...S},G=l()((a,t)=>{const e=Object.assign({},_,t);return{initialization(){try{const i=g(a,e);i&&this.beltline.pushEvent(i)}catch{}this.beltline.addStaff({push(i){R(i.id,i,e)}})}}});export{N as R,P as a,q as b,I as c,Y as d,D as e,k as f,G as g,K as h,H as i,J as j};
