var L=Object.defineProperty;var p=(a,e,t)=>e in a?L(a,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):a[e]=t;var i=(a,e,t)=>(p(a,typeof e!="symbol"?e+"":e,t),t);import{a6 as I,a5 as U,a8 as c,am as C,ac as E,ah as n,an as d,ad as R,af as b,ae as P,ao as B,X as f,a1 as u,S,Y as g,a2 as M,a3 as k,ag as l}from"./index.de60ca02.js";import{R as m,f as K,h as O,a as y,d as v,c as $}from"./getCacheStaff.283a43f7.js";function W(){return I({feat:{useMetadata(){const a=this.beltline.feat.getLatestEvent();return a?h(a):{}},onHasMetadata(a){this.beltline.feat.onHasLatestEvent((e,t)=>{a(h(e),t)})}}})}function h(a){let e={};try{const t=U(a.tags);e.relayUrls=[...t],a&&(e=JSON.parse(a.content))}catch{}return e}const F=c()(a=>{const e=new C.exports;return{afterPush(t,s){if(s.length>a){const r=s.pop();e.emit("limit-pop",r)}},feat:{onLimitPop(t){e.on("limit-pop",t)}}}});class H{constructor(e){i(this,"filters");i(this,"filtersKey");i(this,"eventIdList");i(this,"list",null);i(this,"cacheOptions",{...E,duration:n.localStorage.duration});this.filters=e;let t=JSON.stringify(e);if(t.length>256){const r=d.taggedHashSync(t);this.filtersKey=`LocalStorageFilter:${d.sha256(r)}`}else this.filtersKey=`LocalStorageFilter:${t}`;const s=localStorage.getItem(this.filtersKey);try{this.eventIdList=s?JSON.parse(s):[]}catch{this.eventIdList=[]}}getWholeEvent(){const e=[];for(const t of this.eventIdList)try{const s=this.getItem(t);if(!s)break;e.push(s)}catch{}return e}clear(){for(const e of this.eventIdList)this.removeItem(e)}createKey(e){return e}setItem(e){const t=this.createKey(e.id);R(t,e,this.cacheOptions),this.eventIdList.push(e.id),this.updateList()}getItem(e){try{return b(this.createKey(e),this.cacheOptions)}catch{this.removeItem(e)}}removeItem(e){P(this.createKey(e)),B(this.eventIdList,e),this.updateList()}updateList(){localStorage.setItem(this.filtersKey,JSON.stringify(this.eventIdList))}}const J=c()((a=1e3)=>{let e=null;return{initialization(){if(e=new H(this.beltline.getFilters()),a===0)return;const t=e.getWholeEvent();for(const r of t)this.beltline.pushEvent(r);this.beltline.createChild({}).addStaff({push(r){e.setItem(r)}}).addStaffOfReverseSortByCreateAt().addStaff(F(a)).feat.onLimitPop(r=>{e.removeItem(r.id)})},feat:{removeItem(t){e==null||e.removeItem(t)},getItem(t){return console.debug("getItem",t,"localStorageFilter",e,"event",e==null?void 0:e.getItem(t)),e==null?void 0:e.getItem(t)}}}}),N=c()(()=>{const a=new Map;return{push(e){var r,o;const t=e.pubkey;let s=a.get(t);s?e.created_at>s.created_at&&((o=(r=this.beltline.feat).removeItem)==null||o.call(r,s.pubkey),a.set(t,e)):a.set(t,e)}}});f.createChild({preventCircularReferences:!0}).addFilter({kinds:[10002]}).addStaff(J(1e3)).addStaff(N());function A(a){return u(`getUserRelayUrlConfigByPubkey:${a}`,()=>{const e=S(f.createChild()).addFilter({kinds:[10002],authors:[a]}).addStaff(g()).addStaff(m(10002,a)).addStaff(K()).addStaff(O()).addStaff(y()).addExtends(f);return e.feat.withEvent()||e.createChild().addStaff(v(a)),e},{useLocalStorage:!1})}function T(a,e){const{urls:t}=e!=null?e:{};return u(`getUserMetadataLineByPubkey:${a}`,()=>{const s=M().createChild({slef:S({})}).addFilter({authors:[a],kinds:[0]}).addStaff(g()).addStaff(m(0,a)).addStaff(W()).addStaff(k()).addStaff($()).addStaff(y()),r=()=>{s.addRelayUrls(t),s.addReadUrl(),s.addStaff(v(a))};return s.feat.isHas()?l(`getUserMetadataLineByPubkey0${a}`,r,n.syncInterval4):l(`getUserMetadataLineByPubkey1${a}`,r,n.syncInterval),s},{useLocalStorage:!1})}export{A as a,W as c,T as g,h as p};
