import{a6 as A,ai as u,a7 as S,ac as _,a8 as w,aj as x,a3 as F,ak as z,ad as D,a1 as j,a2 as q,X as T,ag as N,$,U as G,al as M,a9 as p}from"./index.de60ca02.js";import{b as R,c as K,e as B,a as J,g as X,d as H}from"./getCacheStaff.283a43f7.js";import{c as Q}from"./autoAddRelayurlByEventIdStaff.73b12553.js";function te(){return A({push(r){if(r.created_at>u())return S.BREAK}})}const V=r=>`createRefreshLoadStaff:${JSON.stringify(r)}`,b={..._,duration:1e3*60*30},ne=w()((r,t=20,i)=>{var I;const o=new WeakMap,v=V(r),l=(I=x(v,b))!=null?I:{loadBufferOpt:void 0,refreshBufferOpt:{minSince:u()}},d=y(l.loadBufferOpt),h=y(l.refreshBufferOpt);return{initialization(){var a;const e=(a=i==null?void 0:i.eventBeltline)!=null?a:this.beltline;h.bufferLine=e.createChild().addStaff(R()).addStaff({push(n,s,f){if(L(n,f),h.bufferCounter.reduce(),h.bufferCounter.count<t)return e.pushEvent(n,f),S.BREAK}}).addStaffOfReverseSortByCreateAt(),d.bufferLine=e.createChild().addStaff(R()).addStaff({push(n,s,f){if(L(n,f),d.bufferCounter.reduce(),d.bufferCounter.count<t)return e.pushEvent(n,f),S.BREAK}}).addStaffOfReverseSortByCreateAt()},feat:{loadBufferOpt:d,refreshBufferOpt:h,firstLoad(){const e=this.beltline.feat.loadBufferOpt;e.isLoading=!0;const a=this.beltline,n=a.createChild().addFilters(r.map(s=>({...s,limit:t}))).addStaff({push(){e.bufferCounter.count+1>=t&&(e.isLoading=!1)}});setTimeout(()=>{e.isLoading=!1},20),a.onAddRelayUrlsAfter(s=>{n.addRelayUrls(s)}),n.addRelayUrls(a.getRelayUrls()),e.bufferLine.addExtends(n)},refresh(){const e=(a,n)=>{const s=n.until,f=n.until+n.timeIncrement;if(f>u()){if(a(),n.timeIncrement=n.timeIncrement/2,n.timeIncrement<60&&(n.timeIncrement=60),s>u()){n.until=u();return}}else n.until=f;return r.map(c=>({...c,since:s,until:f}))};E(this.beltline.feat.refreshBufferOpt,this.beltline,e)},load(){const e=(a,n)=>{const s=n.since,f=n.since=n.since-n.timeIncrement;if(!(f<1640966400&&(a(),s<1640966400)))return r.map(c=>({...c,since:f,until:s}))};E(this.beltline.feat.loadBufferOpt,this.beltline,e)}}};function E(e,a,n){if(r.length===0)return;const s=a.getRelayUrls(),f=e.bufferLine.getList(),c=f.splice(f.length-t,t);c.length<t&&k(e,s,c.length,(...g)=>{C(a);const m=n(...g);return C(a),m}),U(c,a)}function C(e){D(v,{loadBufferOpt:{timeIncrement:e.feat.loadBufferOpt.timeIncrement},refreshBufferOpt:{timeIncrement:e.feat.refreshBufferOpt.timeIncrement}},b)}function k(e,a,n,s){const f=()=>{clearInterval(e.intervalId),e.isLoading=!1};e.bufferCounter.count>t&&(e.timeIncrement=Math.floor(e.timeIncrement/(e.bufferCounter.count/t))),e.timeIncrement<60&&(e.timeIncrement=60),e.bufferCounter.set(n),f(),e.isLoading=!0,e.intervalId=setInterval(c,4e3),setTimeout(()=>c(!0));function c(g){if(e.isLoading=!0,e.bufferCounter.count>=t){f();return}else g||(e.timeIncrement=e.timeIncrement*2);const m=s(f,e);if(!!m&&a.size!==0)for(const P of a)e.bufferLine.addExtends(e.bufferLine.createChild().addStaff(K()).addStaff(F()).addFilters(m).addRelayUrl(P))}}function L(e,a){o.set(e,{event:e,opt:a})}function U(e,a){for(const n of e){const s=W(n);a.pushEvent(n,s==null?void 0:s.opt)}}function W(e){const a=o.get(e);return o.delete(e),a}function y(e){return Object.assign({bufferLine:void 0,bufferCounter:z(0),timeIncrement:600,until:u(),since:u(),createTime:u(),minSince:1640966400,intervalId:void 0,isLoading:!1},e)}}),ae=w()(()=>({initialization(){this.beltline.feat.loadBufferOpt.bufferLine.addStaff(B(),{unshift:!0}),this.beltline.feat.refreshBufferOpt.bufferLine.addStaff(B(),{unshift:!0})}}));function re(){const r=new Set;return A({push(t){if(r.has(t.content))return S.BREAK;r.add(t.content)}})}async function Y(r,t,i){return new Promise((o,v)=>{const l=$({kind:5,pubkey:G.value.publicKey,tags:r.map(d=>["e",d])});T.createChild().publish(l,M(p.getWriteList(),t!=null?t:new Set),i)})}function ie(r,t){Y([r],t==null?void 0:t.urls,t)}function se(r,t){return j("getEventLineById"+r,()=>{const i=q({describe:"\u83B7\u53D6Event\u901A\u8FC7id"}).addFilter({ids:[r],limit:1}).addStaff(Q()).addStaff(J()).addStaff(B()).addStaff(F()).addStaff(K());if(i.addStaff(X(r)),i.feat.withEvent()||(i.addExtends(T),i.feat.withEvent()))return i;const o=async()=>{(t==null?void 0:t.urls)&&t.urls.size>0&&(i.addRelayUrls(t.urls),await i.feat.timeoutWithEvent())||t!=null&&t.pubkey&&(i.addStaff(H(t.pubkey)),await i.feat.timeoutWithEvent())||(i.addReadUrl(),await i.feat.timeoutWithEvent())};return N(`getEventLineById:${r}`,()=>{o()},20*1e3),i},{useLocalStorage:!1})}export{ae as a,te as b,ne as c,re as d,ie as e,se as g};
